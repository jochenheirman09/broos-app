rules_version = '2';

service cloud.firestore {
    match /databases/{database}/documents {

        // --- HELPER FUNCTIONS ---
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(userId) {
            return request.auth.uid == userId;
        }

        function isCreatingOwnData(userId) {
            return isOwner(userId) && request.resource.data.uid == userId;
        }

        function isResponsibleForClub(clubId) {
            let profile = get(/databases/$(database)/documents/users/$(request.auth.uid));
            return profile.exists
                && profile.data.get('role', 'none') == 'responsible'
                && profile.data.get('clubId', null) == clubId;
        }

        function isStaff() {
            let profile = get(/databases/$(database)/documents/users/$(request.auth.uid));
            return profile.exists && profile.data.get('role', 'none') == 'staff';
        }

        function getMyTeamId() {
            let profile = get(/databases/$(database)/documents/users/$(request.auth.uid));
            return profile.exists ? profile.data.get('teamId', null) : null;
        }

        function getMyClubId() {
            let profile = get(/databases/$(database)/documents/users/$(request.auth.uid));
            return profile.exists ? profile.data.get('clubId', null) : null;
        }

        // --- COLLECTION GROUP RULES ---

        match /{path=**}/alerts/{alertId} {
            function canReadAlerts() {
                let profile = get(/databases/$(database)/documents/users/$(request.auth.uid));
                
                // Syntactische Fix: Combineer de exists check en logica
                return profile.exists && (
                    (profile.data.get('role', 'none') == 'responsible' && profile.data.get('clubId', null) == resource.data.get('clubId', null)) ||
                    (profile.data.get('role', 'none') == 'staff' && profile.data.get('teamId', null) == resource.data.get('teamId', null))
                );
            }

            allow read: if isSignedIn() && canReadAlerts();
        }

        // --- COLLECTION RULES ---

        match /users/{userId} {
            allow get: if isSignedIn() && request.auth.uid == userId;

            // TIJDELIJKE VEREENVOUDIGING (MOET VEILIG GEMAAKT WORDEN NA DEPLOYMENT)
            allow list: if isSignedIn() && (
                (isResponsibleForClub(getMyClubId()) || isStaff())
            );

            allow create: if isCreatingOwnData(userId);
            allow update: if isOwner(userId);
            allow delete: if false;

            match /chats/{chatId} { allow read, write: if isOwner(userId); match /messages/{messageId} { allow read, write: if isOwner(userId); } }
            match /wellnessScores/{scoreId} { allow read, write: if isOwner(userId); }
            match /trainings/{trainingId} { allow read, write: if isOwner(userId); }
            match /fcmTokens/{tokenId} { allow write: if isOwner(userId); }
            match /updates/{updateId} { allow read: if isOwner(userId); allow write: if false; }
        }

        match /p2p_chats/{chatId} {
            allow read, update: if isSignedIn() && request.auth.uid in resource.data.participants;
            allow create: if isSignedIn() && request.auth.uid in request.resource.data.participants;

            match /messages/{messageId} {
                allow read, list, create: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/p2p_chats/$(chatId)).data.participants;
            }
        }

        match /clubs/{clubId} {
            allow get: if isSignedIn();
            allow list: if isSignedIn();
            allow create: if isSignedIn();
            allow update, delete: if isResponsibleForClub(clubId);

            match /teams/{teamId} {

                function canReadTeam(clubId, teamId) {
                    let profile = get(/databases/$(database)/documents/users/$(request.auth.uid));

                    // Syntactische Fix + Player Logica
                    return profile.exists && (
                        (profile.data.get('role', 'none') == 'responsible' && profile.data.get('clubId', null) == clubId) ||
                        (profile.data.get('role', 'none') == 'staff' && profile.data.get('teamId', null) == teamId) ||
                        (profile.data.get('role', 'none') == 'player' && profile.data.get('teamId', null) == teamId)
                    );
                }

                allow read: if isSignedIn() && canReadTeam(clubId, teamId);
                allow list, create, update, delete: if isResponsibleForClub(clubId);

                match /summaries/{summaryId} {
                    allow read: if isSignedIn() && canReadTeam(clubId, teamId);
                    allow write: if false;
                }

                match /staffUpdates/{updateId} {
                    allow read: if isSignedIn() && canReadTeam(clubId, teamId);
                    allow write: if false;
                }

                match /alerts/{alertId} {
                    allow read: if isSignedIn() && canReadTeam(clubId, teamId);
                    allow write: if isOwner(request.resource.data.userId)
                                 || isResponsibleForClub(clubId)
                                 || (isStaff() && teamId == getMyTeamId());
                }
            }

            match /clubUpdates/{updateId} {
                allow read: if isResponsibleForClub(clubId);
                allow write: if false;
            }
        }

        match /knowledge_base/{docId} {
            function isResponsibleGlobal() {
                let profile = get(/databases/$(database)/documents/users/$(request.auth.uid));
                return profile.exists && profile.data.get('role', 'none') == 'responsible';
            }
            allow read, list: if isResponsibleGlobal();
            allow create, update, delete: if false;
        }

        match /knowledge_stats/{statId} {
            allow read: if isResponsibleForClub(getMyClubId());
            allow write: if false;
        }
    }
}